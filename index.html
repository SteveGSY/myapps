<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home Behaviour Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<!-- PWA meta -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    min-height: 100vh;
    margin: 0;
    padding: 0;
    padding-bottom: 100px; /* space for floating buttons */
    background: #f5f5f5;
    background: radial-gradient(circle at top left, #ff9a9e 0, #fad0c4 30%, #a1c4fd 70%, #c2e9fb 100%);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
  }
  .app-shell {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.22);
    border-radius: 22px;
    border: 1px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
  }
  .glass-bar {
    background: rgba(255, 255, 255, 0.18);
    border-radius: 26px;
    border: 1px solid rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }
  .fade-page {
    transition: opacity 0.25s ease, transform 0.25s ease;
  }
  .fade-page.hidden {
    opacity: 0;
    transform: translateX(10px);
    pointer-events: none;
  }
  .fade-page.active {
    opacity: 1;
    transform: translateX(0);
  }

  /* Score animations */
  .score-pop {
    animation: popScore 0.35s ease-out;
  }
  @keyframes popScore {
    0%   { transform: scale(1); }
    30%  { transform: scale(1.25); }
    60%  { transform: scale(0.95); }
    100% { transform: scale(1); }
  }

  .score-shake {
    animation: shakeScore 0.45s ease-in-out;
  }
  @keyframes shakeScore {
    0% { transform: translateX(0); }
    20% { transform: translateX(-6px); }
    40% { transform: translateX(6px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
    100% { transform: translateX(0); }
  }

  .flash-green {
    animation: flashGreen 0.45s ease-out;
  }
  .flash-red {
    animation: flashRed 0.45s ease-out;
  }
  @keyframes flashGreen {
    0% { background-color: rgba(34,197,94,0.6); }
    100% { background-color: transparent; }
  }
  @keyframes flashRed {
    0% { background-color: rgba(239,68,68,0.6); }
    100% { background-color: transparent; }
  }

  /* Floating glass buttons */
  .floating-nav {
    position: fixed;
    bottom: 18px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 16px;
    z-index: 50;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
  }
  .floating-btn {
    width: 56px;
    height: 56px;
    border-radius: 9999px;
    background: rgba(255, 255, 255, 0.22);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 18px 45px rgba(15, 23, 42, 0.35);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
  }
  .floating-btn span {
    display: block;
  }
  .floating-btn:active {
    transform: scale(0.94);
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.4);
  }
  .floating-btn-active {
    background: rgba(59,130,246,0.25);
    border-color: rgba(59,130,246,0.9);
  }

  @media (max-width: 480px) {
    .glass-card, .glass-bar {
      padding: 12px !important;
    }
    h1, h2, h3 {
      font-size: 1rem !important;
    }
    #eventForm input, #eventForm select {
      font-size: 0.9rem !important;
    }
  }
</style>
</head>

<body>
<div class="app-shell px-3 sm:px-4">
  <div class="w-full max-w-xl mx-auto flex flex-col gap-4 sm:gap-6 h-full">

    <!-- Top App Bar -->
    <header class="glass-bar px-4 py-3 flex items-center justify-between mt-3 sm:mt-4">
      <div class="flex items-center gap-2">
        <span id="backFromCharts" class="hidden text-sm text-blue-600 font-semibold cursor-pointer select-none">
          â€¹ Tracker
        </span>
      </div>
      <div class="text-center flex-1">
        <h1 class="text-lg sm:text-xl font-semibold text-slate-900">Home Behaviour</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="fullscreenBtn"
          class="text-xs sm:text-sm px-3 py-1.5 rounded-full bg-white/70 text-slate-800 shadow-sm active:scale-95 transition">
          Fullscreen
        </button>
      </div>
    </header>

    <!-- Main Content Card -->
    <main class="glass-card flex-1 p-4 sm:p-6 flex flex-col overflow-hidden max-w-full">
      <!-- TRACKER PAGE -->
      <div id="trackerPage" class="fade-page active flex flex-col gap-4 sm:gap-6 h-full">

        <!-- Export / Import -->
        <div class="flex flex-wrap gap-2 justify-end">
          <button id="exportBtn"
            class="bg-emerald-500/90 text-white px-3 py-1.5 rounded-full text-xs sm:text-sm shadow active:scale-95 transition">
            Export CSV
          </button>
          <label
            class="bg-slate-700/90 text-white px-3 py-1.5 rounded-full text-xs sm:text-sm shadow cursor-pointer active:scale-95 transition">
            Import CSV
            <input id="importInput" type="file" accept=".csv" class="hidden">
          </label>
        </div>

        <!-- Score Box Row -->
        <div class="flex gap-2 w-full text-center">
          <div class="glass-card flex-1 p-2 sm:p-3 shadow-sm">
            <p class="text-[10px] sm:text-xs text-slate-600">Today</p>
            <p id="todayScore" class="text-xl sm:text-2xl font-semibold text-slate-900">0</p>
          </div>
          <div class="glass-card flex-1 p-2 sm:p-3 shadow-sm">
            <p class="text-[10px] sm:text-xs text-slate-600">This Week</p>
            <p id="weekScore" class="text-xl sm:text-2xl font-semibold text-slate-900">0</p>
          </div>
          <div class="glass-card flex-1 p-2 sm:p-3 shadow-sm">
            <p class="text-[10px] sm:text-xs text-slate-600">Total</p>
            <p id="totalScore" class="text-xl sm:text-2xl font-semibold text-slate-900">0</p>
          </div>
        </div>

        <!-- Add Behaviour -->
        <section class="glass-card p-4 sm:p-5 flex flex-col gap-3 sm:gap-4">
          <h2 class="text-base sm:text-lg font-semibold text-slate-900">Add Behaviour</h2>

          <form id="eventForm" class="space-y-3 sm:space-y-4">

            <div>
              <label class="block text-xs sm:text-sm font-medium mb-1 text-slate-700">Behaviour Type</label>
              <div class="flex flex-wrap gap-4">
                <label class="flex items-center gap-1 text-sm text-slate-800">
                  <input type="radio" name="type" value="positive" checked>
                  <span>Positive</span>
                </label>
                <label class="flex items-center gap-1 text-sm text-slate-800">
                  <input type="radio" name="type" value="negative">
                  <span>Negative</span>
                </label>
              </div>
            </div>

            <div>
              <label for="category" class="block text-xs sm:text-sm font-medium mb-1 text-slate-700">Category</label>
              <select id="category"
                class="border border-white/60 bg-white/60 rounded-full px-3 py-2 w-full sm:w-auto sm:min-w-[150px] text-sm shadow-inner">
                <option>Helping</option>
                <option>Homework</option>
                <option>Kindness</option>
                <option>Not listening</option>
                <option>Rudeness</option>
              </select>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label for="points" class="block text-xs sm:text-sm font-medium mb-1 text-slate-700">Points</label>
                <input id="points" type="number" value="1"
                  class="border border-white/60 bg-white/60 rounded-full px-3 py-2 w-full text-sm shadow-inner">
              </div>

              <div>
                <label for="notes" class="block text-xs sm:text-sm font-medium mb-1 text-slate-700">Notes</label>
                <input id="notes" type="text" placeholder="Notes (optional)"
                  class="border border-white/60 bg-white/60 rounded-full px-3 py-2 w-full text-sm shadow-inner">
              </div>
            </div>

            <button
              class="mt-1 bg-blue-600 text-white px-4 py-2.5 rounded-full w-full text-sm sm:text-base font-medium shadow-md active:scale-95 transition">
              Add Behaviour
            </button>
          </form>
        </section>

        <!-- Recent Events -->
        <section class="glass-card p-4 sm:p-5 flex-1 flex flex-col min-h-0">
          <h2 class="text-base sm:text-lg font-semibold mb-2 text-slate-900">Recent Events</h2>

          <div class="overflow-x-auto rounded-2xl border border-white/40 bg-white/40 flex-1 min-h-0 w-full">
            <table class="w-full border-collapse text-sm">
              <thead class="bg-white/70">
                <tr class="text-left text-slate-700">
                  <th class="p-2">Time</th>
                  <th class="p-2">Type</th>
                  <th class="p-2">Category</th>
                  <th class="p-2">Points</th>
                  <th class="p-2">Notes</th>
                  <th class="p-2">Delete</th>
                </tr>
              </thead>
              <tbody id="eventsTableBody" class="bg-white/40"></tbody>
            </table>
          </div>
        </section>

      </div>

      <!-- CHARTS PAGE -->
      <div id="chartsPage" class="fade-page hidden flex-col gap-4 sm:gap-5 h-full">
        <div class="flex justify-between items-center">
          <h2 class="text-base sm:text-lg font-semibold text-slate-900">Charts & Analytics</h2>
          <span class="text-xs sm:text-sm text-slate-600">Based on all saved events</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-5 flex-1 min-h-0">
          <div class="glass-card p-3 sm:p-4 flex flex-col">
            <h3 class="font-semibold mb-2 text-sm sm:text-base text-slate-900">Points This Week</h3>
            <canvas id="weeklyChart" class="flex-1" height="120"></canvas>
          </div>

          <div class="glass-card p-3 sm:p-4 flex flex-col">
            <h3 class="font-semibold mb-2 text-sm sm:text-base text-slate-900">Points Today</h3>
            <canvas id="dailyChart" class="flex-1" height="120"></canvas>
          </div>

          <div class="glass-card p-3 sm:p-4 flex flex-col">
            <h3 class="font-semibold mb-2 text-sm sm:text-base text-slate-900">Points This Month</h3>
            <canvas id="monthlyChart" class="flex-1" height="120"></canvas>
          </div>

          <div class="glass-card p-3 sm:p-4 flex flex-col">
            <h3 class="font-semibold mb-2 text-sm sm:text-base text-slate-900">Points by Category</h3>
            <canvas id="categoryChart" class="flex-1" height="120"></canvas>
          </div>
        </div>
      </div>
    </main>

  </div>
</div>

<!-- Floating glass circular nav -->
<div class="floating-nav">
  <button id="tabTracker" class="floating-btn floating-btn-active" title="Tracker">
    <span>ðŸ”µ</span>
  </button>
  <button id="tabCharts" class="floating-btn" title="Charts">
    <span>ðŸ“Š</span>
  </button>
</div>

<script>
// ----------------------
// Standalone App Logic
// ----------------------
const STORAGE_KEY = "behaviourEvents";
let events = [];

function loadEvents() {
  const raw = localStorage.getItem(STORAGE_KEY);
  events = raw ? JSON.parse(raw) : [];
  events.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
}

function saveEvents() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
}

function deleteEvent(id) {
  events = events.filter(e => String(e.id) !== String(id));
  saveEvents();
  render();
  renderCharts();
}

function addEvent(event) {
  events.push(event);
  events.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  saveEvents();
  render();
  renderCharts();
}

function getTodayRange() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const end = new Date(start);
  end.setDate(end.getDate() + 1);
  return { start, end };
}

function getWeekRange() {
  const now = new Date();
  const day = now.getDay();
  const monday = new Date(now);
  monday.setDate(now.getDate() - ((day + 6) % 7));
  monday.setHours(0, 0, 0, 0);
  const end = new Date(monday);
  end.setDate(end.getDate() + 7);
  return { start: monday, end };
}

function getMonthRange() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
  return { start, end };
}

function calculateScore(range) {
  return events
    .filter(e => {
      const t = new Date(e.timestamp);
      return t >= range.start && t < range.end;
    })
    .reduce((sum, e) => sum + e.points, 0);
}

// ----------------------
// Score animations
// ----------------------
function animateScore(id, type) {
  const el = document.getElementById(id);
  if (!el) return;

  el.classList.remove("score-pop", "score-shake", "flash-green", "flash-red");
  void el.offsetWidth;

  if (type === "positive") {
    el.classList.add("score-pop", "flash-green");
  } else if (type === "negative") {
    el.classList.add("score-shake", "flash-red");
  }
}

function renderScores() {
  const today = calculateScore(getTodayRange());
  const week = calculateScore(getWeekRange());
  const total = events.reduce((sum, e) => sum + e.points, 0);

  const todayEl = document.getElementById("todayScore");
  const weekEl = document.getElementById("weekScore");
  const totalEl = document.getElementById("totalScore");

  const prevToday = Number(todayEl.textContent) || 0;
  const prevWeek = Number(weekEl.textContent) || 0;
  const prevTotal = Number(totalEl.textContent) || 0;

  if (todayEl.textContent != today) {
    const type = today > prevToday ? "positive" : "negative";
    animateScore("todayScore", type);
  }
  if (weekEl.textContent != week) {
    const type = week > prevWeek ? "positive" : "negative";
    animateScore("weekScore", type);
  }
  if (totalEl.textContent != total) {
    const type = total > prevTotal ? "positive" : "negative";
    animateScore("totalScore", type);
  }

  todayEl.textContent = today;
  weekEl.textContent = week;
  totalEl.textContent = total;
}

// ----------------------
// Events table
// ----------------------
function renderEventsTable() {
  const tbody = document.getElementById("eventsTableBody");
  tbody.innerHTML = "";

  [...events]
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
    .forEach(e => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="p-2 text-xs sm:text-sm">${new Date(e.timestamp).toLocaleString()}</td>
        <td class="p-2 text-xs sm:text-sm ${e.type === "positive" ? "text-green-600" : "text-red-600"}">${e.type}</td>
        <td class="p-2 text-xs sm:text-sm">${e.category}</td>
        <td class="p-2 text-xs sm:text-sm">${e.points}</td>
        <td class="p-2 text-xs sm:text-sm">${e.notes || ""}</td>
        <td class="p-2 text-xs sm:text-sm">
          <button class="text-red-600 font-bold" onclick="deleteEvent('${e.id}')">âœ–</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
}

// ----------------------
// Chart Helpers
// ----------------------
let weeklyChart, dailyChart, monthlyChart, categoryChart;

function getDailyTotals() {
  const today = getTodayRange();
  const hours = Array.from({ length: 24 }, (_, i) => i);

  const totals = hours.map(h => {
    return events
      .filter(e => {
        const t = new Date(e.timestamp);
        return t >= today.start && t < today.end && t.getHours() === h;
      })
      .reduce((sum, e) => sum + e.points, 0);
  });

  return { hours, totals };
}

function getWeeklyTotals() {
  const week = getWeekRange();
  const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

  const totals = days.map((_, i) => {
    const dayStart = new Date(week.start);
    dayStart.setDate(dayStart.getDate() + i);

    const dayEnd = new Date(dayStart);
    dayEnd.setDate(dayEnd.getDate() + 1);

    return events
      .filter(e => {
        const t = new Date(e.timestamp);
        return t >= dayStart && t < dayEnd;
      })
      .reduce((sum, e) => sum + e.points, 0);
  });

  return { days, totals };
}

function getMonthlyTotals() {
  const month = getMonthRange();
  const daysInMonth = new Date(month.start.getFullYear(), month.start.getMonth() + 1, 0).getDate();
  const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);

  const totals = labels.map(d => {
    const dayStart = new Date(month.start.getFullYear(), month.start.getMonth(), d);
    const dayEnd = new Date(month.start.getFullYear(), month.start.getMonth(), d + 1);

    return events
      .filter(e => {
        const t = new Date(e.timestamp);
        return t >= dayStart && t < dayEnd;
      })
      .reduce((sum, e) => sum + e.points, 0);
  });

  return { labels, totals };
}

function getCategoryTotals() {
  const map = {};
  events.forEach(e => {
    map[e.category] = (map[e.category] || 0) + e.points;
  });
  const labels = Object.keys(map);
  const totals = labels.map(l => map[l]);
  return { labels, totals };
}

function renderCharts() {
  const weekly = getWeeklyTotals();
  const daily = getDailyTotals();
  const monthly = getMonthlyTotals();
  const category = getCategoryTotals();

  if (weeklyChart) weeklyChart.destroy();
  if (dailyChart) dailyChart.destroy();
  if (monthlyChart) monthlyChart.destroy();
  if (categoryChart) categoryChart.destroy();

  const weeklyCtx = document.getElementById("weeklyChart");
  const dailyCtx = document.getElementById("dailyChart");
  const monthlyCtx = document.getElementById("monthlyChart");
  const categoryCtx = document.getElementById("categoryChart");

  if (!weeklyCtx || !dailyCtx || !monthlyCtx || !categoryCtx) return;

  weeklyChart = new Chart(weeklyCtx, {
    type: "bar",
    data: {
      labels: weekly.days,
      datasets: [{
        label: "Points",
        data: weekly.totals,
        backgroundColor: "#2563eb88",
        borderColor: "#2563eb",
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });

  dailyChart = new Chart(dailyCtx, {
    type: "line",
    data: {
      labels: daily.hours.map(h => `${h}:00`),
      datasets: [{
        label: "Points",
        data: daily.totals,
        borderColor: "#16a34a",
        backgroundColor: "#16a34a55",
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });

  monthlyChart = new Chart(monthlyCtx, {
    type: "bar",
    data: {
      labels: monthly.labels,
      datasets: [{
        label: "Points",
        data: monthly.totals,
        backgroundColor: "#f9731688",
        borderColor: "#f97316",
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });

  categoryChart = new Chart(categoryCtx, {
    type: "pie",
    data: {
      labels: category.labels,
      datasets: [{
        data: category.totals,
        backgroundColor: [
          "#2563eb88",
          "#16a34a88",
          "#f9731688",
          "#e11d4888",
          "#a855f788"
        ],
        borderColor: "#ffffff",
        borderWidth: 2
      }]
    },
    options: {
      responsive: true
    }
  });
}

// ----------------------
// CSV Export / Import
// ----------------------
function eventsToCSV() {
  const header = ["id","type","category","points","notes","timestamp"];
  const rows = events.map(e => [
    e.id,
    e.type,
    e.category,
    e.points,
    (e.notes || "").replace(/"/g, '""'),
    e.timestamp
  ]);

  const csv = [header.join(",")]
    .concat(rows.map(r =>
      r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",")
    ))
    .join("\r\n");

  return csv;
}

function downloadCSV() {
  const csv = eventsToCSV();
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const now = new Date();
  const stamp = now.toISOString().slice(0,10);
  a.href = url;
  a.download = `behaviour-data-${stamp}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
  if (lines.length < 2) return [];

  const header = lines[0].split(",").map(h => h.replace(/^"|"$/g, ""));
  const idx = name => header.indexOf(name);

  const idIdx = idx("id");
  const typeIdx = idx("type");
  const catIdx = idx("category");
  const pointsIdx = idx("points");
  const notesIdx = idx("notes");
  const tsIdx = idx("timestamp");

  const result = [];

  for (let i = 1; i < lines.length; i++) {
    const row = [];
    let cur = "";
    let inQuotes = false;
    const line = lines[i];

    for (let c = 0; c < line.length; c++) {
      const ch = line[c];
      if (ch === '"' && line[c+1] === '"') {
        cur += '"';
        c++;
      } else if (ch === '"') {
        inQuotes = !inQuotes;
      } else if (ch === "," && !inQuotes) {
        row.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    row.push(cur);

    if (row.length !== header.length) continue;

    const obj = {
      id: row[idIdx] ? row[idIdx] : (window.crypto && crypto.randomUUID ? crypto.randomUUID() : (Date.now() + i)),
      type: row[typeIdx] || "positive",
      category: row[catIdx] || "Other",
      points: Number(row[pointsIdx]) || 0,
      notes: row[notesIdx] || "",
      timestamp: row[tsIdx] || new Date().toISOString()
    };
    result.push(obj);
  }

  return result;
}

function handleImportFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    const imported = parseCSV(text);
    if (imported.length > 0) {
      events = imported.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      saveEvents();
      render();
      renderCharts();
      alert(`Imported ${imported.length} records.`);
    } else {
      alert("No valid records found in CSV.");
    }
  };
  reader.readAsText(file);
}

// ----------------------
// Navigation between pages
// ----------------------
function showTracker() {
  const tracker = document.getElementById("trackerPage");
  const charts = document.getElementById("chartsPage");
  tracker.classList.remove("hidden");
  charts.classList.add("hidden");
  tracker.classList.add("active");
  charts.classList.remove("active");

  document.getElementById("backFromCharts").classList.add("hidden");

  const tabTracker = document.getElementById("tabTracker");
  const tabCharts = document.getElementById("tabCharts");
  tabTracker.classList.add("floating-btn-active");
  tabCharts.classList.remove("floating-btn-active");
}

function showCharts() {
  const tracker = document.getElementById("trackerPage");
  const charts = document.getElementById("chartsPage");
  tracker.classList.add("hidden");
  charts.classList.remove("hidden");
  charts.classList.add("active");
  tracker.classList.remove("active");

  document.getElementById("backFromCharts").classList.remove("hidden");
  renderCharts();

  const tabTracker = document.getElementById("tabTracker");
  const tabCharts = document.getElementById("tabCharts");
  tabCharts.classList.add("floating-btn-active");
  tabTracker.classList.remove("floating-btn-active");
}

// ----------------------
// Fullscreen
// ----------------------
function toggleFullscreen() {
  const doc = document;
  const docEl = document.documentElement;

  if (!doc.fullscreenElement && !doc.webkitFullscreenElement) {
    if (docEl.requestFullscreen) {
      docEl.requestFullscreen();
    } else if (docEl.webkitRequestFullscreen) {
      docEl.webkitRequestFullscreen();
    }
  } else {
    if (doc.exitFullscreen) {
      doc.exitFullscreen();
    } else if (doc.webkitExitFullscreen) {
      doc.webkitExitFullscreen();
    }
  }
}

document.addEventListener("fullscreenchange", () => {
  const btn = document.getElementById("fullscreenBtn");
  if (!btn) return;
  btn.textContent = document.fullscreenElement ? "Exit Fullscreen" : "Fullscreen";
});

// ----------------------
// Render Everything
// ----------------------
function render() {
  renderScores();
  renderEventsTable();
}

function setupForm() {
  const form = document.getElementById("eventForm");
  form.addEventListener("submit", e => {
    e.preventDefault();

    const type = form.elements["type"].value;
    const category = document.getElementById("category").value;
    let points = Math.abs(parseInt(document.getElementById("points").value, 10) || 0);
    points = type === "negative" ? -points : points;
    const notes = document.getElementById("notes").value;

    const id = (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + Math.random());

    addEvent({
      id,
      type,
      category,
      points,
      notes,
      timestamp: new Date().toISOString()
    });

    document.getElementById("notes").value = "";
  });
}

function setupExportImport() {
  document.getElementById("exportBtn").addEventListener("click", downloadCSV);
  document.getElementById("importInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) {
      handleImportFile(file);
      e.target.value = "";
    }
  });
}

function setupNavigation() {
  document.getElementById("tabTracker").addEventListener("click", showTracker);
  document.getElementById("tabCharts").addEventListener("click", showCharts);
  document.getElementById("backFromCharts").addEventListener("click", showTracker);
}

function setupFullscreen() {
  document.getElementById("fullscreenBtn").addEventListener("click", toggleFullscreen);
}

// ----------------------
// Service worker registration
// ----------------------
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js");
  });
}

function init() {
  loadEvents();
  setupForm();
  setupExportImport();
  setupNavigation();
  setupFullscreen();
  render();
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>